image: node:14.16.0

stages:
  - compile
  - test
  - deploy-heroku

compile-job:
  stage: compile
  script:
    - npm install -f
    - npm run start </dev/null &>/dev/null &
    - npx json-server --watch data/db.json --port 8000 </dev/null &>/dev/null & 

test-job:
  stage: test
  script:
    - echo hello

heroku-deploy:
  image: ruby:latest
  stage: deploy-heroku
  script:
   - apt-get update -qy
   - apt-get install -y python3 python3-pip
   - pip3 install -r requirements.txt
   - gem install dpl
   - dpl --provider=heroku --app=drp-inaglobe-platform --api-key=$HEROKU_API
